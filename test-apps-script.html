<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Google Apps Script Connection</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #696cff;
        padding-bottom: 10px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
        border-left: 4px solid #696cff;
      }
      button {
        background: #696cff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }
      button:hover {
        background: #5f61e6;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }
      .loading {
        color: #856404;
        background: #fff3cd;
        border: 1px solid #ffeeba;
      }
      code {
        background: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
      }
      .url-input {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Test Google Apps Script Connection</h1>

      <div class="test-section">
        <h3>üìù Apps Script URL</h3>
        <p>Paste your Google Apps Script deployment URL below:</p>
        <input
          type="text"
          id="scriptUrl"
          class="url-input"
          placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec"
          value="https://script.google.com/macros/s/AKfycbyUQCUiYBjr-OQMCnbtzbcNgfOLEIFHzDiS5Utvj06pLFrXWlhtGMvNlfb4C4X8KwZq/exec"
        />
      </div>

      <div class="test-section">
        <h3>üß™ Test 1: GET Request (Read All)</h3>
        <p>Test <code>?action=getAll</code> endpoint</p>
        <button onclick="testGetAll()">‚ñ∂Ô∏è Test GET All Patients</button>
        <div id="result1"></div>
      </div>

      <div class="test-section">
        <h3>üß™ Test 2: POST Request (Add Patient)</h3>
        <p>Test <code>?action=add</code> endpoint with sample data</p>
        <button onclick="testAddPatient()">‚ñ∂Ô∏è Test ADD Patient</button>
        <div id="result2"></div>
      </div>

      <div class="test-section">
        <h3>üß™ Test 3: POST Request (Update Patient)</h3>
        <p>Test <code>?action=update</code> endpoint</p>
        <button onclick="testUpdatePatient()">
          ‚ñ∂Ô∏è Test UPDATE Patient (ID=2)
        </button>
        <div id="result3"></div>
      </div>

      <div class="test-section">
        <h3>üìä Results Summary</h3>
        <div id="summary" class="result info">
          Click test buttons above to start testing...
        </div>
      </div>
    </div>

    <script>
      function getScriptUrl() {
        return document.getElementById("scriptUrl").value.trim();
      }

      function showResult(elementId, message, type = "info") {
        const element = document.getElementById(elementId);
        element.className = `result ${type}`;
        element.textContent = message;
      }

      async function testGetAll() {
        const url = getScriptUrl();
        if (!url) {
          alert("Please enter Apps Script URL first!");
          return;
        }

        showResult("result1", "‚è≥ Testing GET request...", "loading");

        try {
          const fullUrl = `${url}?action=getAll`;
          console.log("üîµ Testing URL:", fullUrl);

          const response = await fetch(fullUrl, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          });

          console.log("Response status:", response.status);
          console.log(
            "Response headers:",
            Object.fromEntries(response.headers.entries())
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          console.log("‚úÖ Data received:", data);

          const resultText = `‚úÖ SUCCESS!\n\nStatus: ${
            response.status
          }\nData count: ${
            data.length
          } patients\n\nSample data:\n${JSON.stringify(
            data.slice(0, 2),
            null,
            2
          )}`;
          showResult("result1", resultText, "success");
          updateSummary("GET", true);
        } catch (error) {
          console.error("‚ùå Error:", error);
          const errorText = `‚ùå FAILED!\n\nError: ${error.message}\n\nPossible causes:\n- Apps Script not deployed\n- URL incorrect\n- Network/CORS issue`;
          showResult("result1", errorText, "error");
          updateSummary("GET", false, error.message);
        }
      }

      async function testAddPatient() {
        const url = getScriptUrl();
        if (!url) {
          alert("Please enter Apps Script URL first!");
          return;
        }

        showResult("result2", "‚è≥ Testing POST (add) request...", "loading");

        try {
          const testData = {
            TANGGAL: new Date().toISOString().split("T")[0],
            TAHUN: new Date().getFullYear().toString(),
            BULAN: new Date().toLocaleDateString("id-ID", { month: "long" }),
            HARI: new Date().toLocaleDateString("id-ID", { weekday: "long" }),
            ENAM_BELAS_LIMA_BELAS: "Test",
            L: "1",
            P: "0",
            NAMA: "TEST PATIENT - " + new Date().toLocaleTimeString(),
            USIA: "30",
            NIP: "1234567890",
            OBS_TTV: "Normal",
            KELUHAN: "Test keluhan",
            DIAGNOSIS: "Test diagnosis",
            ICD10: "A00",
            TINDAKAN: "Test tindakan",
            OBAT: "Test obat",
          };

          const fullUrl = `${url}?action=add`;
          console.log("üîµ Testing URL:", fullUrl);
          console.log("üîµ Data:", testData);

          const response = await fetch(fullUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(testData),
          });

          console.log("Response status:", response.status);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          console.log("‚úÖ Response:", data);

          const resultText = `‚úÖ SUCCESS!\n\nStatus: ${
            response.status
          }\nResponse: ${JSON.stringify(
            data,
            null,
            2
          )}\n\n‚ö†Ô∏è Check your Google Sheet - new row should be added!`;
          showResult("result2", resultText, "success");
          updateSummary("POST (Add)", true);
        } catch (error) {
          console.error("‚ùå Error:", error);
          const errorText = `‚ùå FAILED!\n\nError: ${error.message}\n\nPossible causes:\n- Apps Script not deployed\n- CORS issue\n- Permission denied`;
          showResult("result2", errorText, "error");
          updateSummary("POST (Add)", false, error.message);
        }
      }

      async function testUpdatePatient() {
        const url = getScriptUrl();
        if (!url) {
          alert("Please enter Apps Script URL first!");
          return;
        }

        showResult("result3", "‚è≥ Testing POST (update) request...", "loading");

        try {
          const testData = {
            id: 2, // Row 2 in sheet
            TANGGAL: new Date().toISOString().split("T")[0],
            TAHUN: new Date().getFullYear().toString(),
            BULAN: "UPDATED",
            HARI: "UPDATED",
            ENAM_BELAS_LIMA_BELAS: "Updated",
            L: "1",
            P: "0",
            NAMA: "UPDATED PATIENT - " + new Date().toLocaleTimeString(),
            USIA: "35",
            NIP: "9999999999",
            OBS_TTV: "Updated",
            KELUHAN: "Updated keluhan",
            DIAGNOSIS: "Updated diagnosis",
            ICD10: "Z99",
            TINDAKAN: "Updated tindakan",
            OBAT: "Updated obat",
          };

          const fullUrl = `${url}?action=update`;
          console.log("üîµ Testing URL:", fullUrl);
          console.log("üîµ Data:", testData);

          const response = await fetch(fullUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(testData),
          });

          console.log("Response status:", response.status);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          console.log("‚úÖ Response:", data);

          const resultText = `‚úÖ SUCCESS!\n\nStatus: ${
            response.status
          }\nResponse: ${JSON.stringify(
            data,
            null,
            2
          )}\n\n‚ö†Ô∏è Check row 2 in Google Sheet - should be updated!`;
          showResult("result3", resultText, "success");
          updateSummary("POST (Update)", true);
        } catch (error) {
          console.error("‚ùå Error:", error);
          const errorText = `‚ùå FAILED!\n\nError: ${error.message}`;
          showResult("result3", errorText, "error");
          updateSummary("POST (Update)", false, error.message);
        }
      }

      const testResults = {};

      function updateSummary(testName, success, errorMsg = "") {
        testResults[testName] = { success, errorMsg };

        let summary = "üìä Test Results:\n\n";
        for (const [name, result] of Object.entries(testResults)) {
          const status = result.success ? "‚úÖ PASS" : "‚ùå FAIL";
          summary += `${status} - ${name}`;
          if (!result.success && result.errorMsg) {
            summary += `\n   Error: ${result.errorMsg}`;
          }
          summary += "\n\n";
        }

        const allPass = Object.values(testResults).every((r) => r.success);
        const type = allPass
          ? "success"
          : Object.keys(testResults).length > 0
          ? "error"
          : "info";

        showResult("summary", summary, type);

        if (allPass && Object.keys(testResults).length === 3) {
          showResult(
            "summary",
            summary +
              "\nüéâ ALL TESTS PASSED!\nYour Google Apps Script is working correctly!",
            "success"
          );
        }
      }
    </script>
  </body>
</html>
